<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <link rel="shortcut icon" href="/favicon.ico"/>

    <style>
        @import url('/lib/element-ui/theme-chalk/index.css');

        body {
            width: 98%;
            margin: 10px auto;
        }

        h1 {
            color: #333;
        }

        .log {
            color: #999;
            font-size: 12px;
        }

        p {
            color: #999;
            font-size: 12px;
        }

        [contenteditable="true"]:empty:before {
            content: attr(placeholder);
            display: block;
            color: #ccc;
        }

        table tr:nth-child(even) {
            background: #F5FAFA;
        }

        .float-right {
            float: right;
        }

        .fixed-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            text-align: center;
        }

        .link {
            margin-right: 30px;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>

<body>
<div id="app" v-cloak>
    <div style="min-height: 72vh;">
        <h1>R&D Message Test</h1>
        <p>ISO8583 CUPS</p>
        Templates:
        <el-select v-model="select" @change="v=>request=v" placeholder="Select a template">
            <el-option
                    v-for="item in options"
                    :key="item.label"
                    :label="item.label"
                    :value="item.value">
            </el-option>
        </el-select>
        Transactions:
        <el-select v-model="selectMessage" @change="v=>request=v.message" placeholder="Select a transaction">
            <el-option
                    v-for="item in requests"
                    :key="item.messageId"
                    :label="item.messageId"
                    :value="item">
            </el-option>
        </el-select>

        <el-row style="margin-top:10px;margin-bottom: 20px">
            <el-col :span="17">
                <el-table
                        ref="multipleTable"
                        :data="fields.filter(data =>  !hide || request[data.no] || response[data.no])"
                        tooltip-effect="dark"
                        border
                        style="width: 100%"
                        @selection-change="handleSelectionChange">
                    <el-table-column
                            type="selection"
                            width="40">
                    </el-table-column>
                    <el-table-column
                            label="Field"
                            width="100">
                        <template slot-scope="scope"><h2>{{ scope.row.no }}</h2></template>
                    </el-table-column>
                    <el-table-column
                            prop="desc"
                            label="Desc"
                            show-overflow-tooltip>
                        <template slot-scope="scope"><h2>{{ scope.row.desc }}</h2></template>
                    </el-table-column>
                    <el-table-column
                            label="Format"
                            show-overflow-tooltip
                            width="200">
                        <template slot-scope="scope"><h2>
                            {{ scope.row.type + (scope.row.fixed ? "" : "..") + scope.row.length + (scope.row.format ? "(" + scope.row.format + ")" : "")
                            }}</h2></template>
                    </el-table-column>
                    <el-table-column
                            label="Request Value">
                        <template slot-scope="scope">
                            <el-input width="350" size="large" v-model="request[scope.row.no]"></el-input>
                        </template>
                    </el-table-column>
                    <el-table-column
                            label="Response Value">
                        <template slot-scope="scope">
                            <el-input width="350" size="large" v-model="response[scope.row.no]"></el-input>
                        </template>
                    </el-table-column>
                </el-table>
                <!--                <div style="margin-top: 20px">-->
                <!--                    <el-button @click="toggleSelection([tableData[1], tableData[2]])">切换第二、第三行的选中状态</el-button>-->
                <!--                    <el-button @click="toggleSelection()">取消选择</el-button>-->
                <!--                </div>-->
            </el-col>
            <el-col :span="7">
                <el-row style="margin-bottom: 20px">
                    <el-switch
                            v-model="hide"
                            inactive-text="ShowEmpty"
                            active-text="HideEmpty">
                    </el-switch>
                    &nbsp;&nbsp;
                    <el-switch
                            v-model="post"
                            inactive-text="Socket"
                            active-text="Post">
                    </el-switch>
                </el-row>
                <el-row style="margin-bottom: 20px">
                    <el-button type="primary" v-loading="loading" @click="submitForm">Send</el-button>
                </el-row>
                <el-row style="margin-bottom: 20px">
                    Console:
                    <br/>
                    <div style="border: 1px solid gray;width: 100%;min-height: 420px;max-height: 420px;text-align: left;overflow-x: auto !important;overflow-y: auto !important"
                         ref="chatScroll">
                        <div v-for="(v,k) in info" style="text-align: left">
                            <div style="text-align: left">
                                <span class="log">[{{v.time}}][{{v.type}}][seq:{{k}}]</span>
                            </div>
                            <pre v-if="v.type==='send'">{{JSON.stringify(v.message, null, 2)}}</pre>
                            <div v-else>
                                <pre> <span class="log">request:</span><br/>{{JSON.stringify(v.message.request, null, 2)}}</pre>
                                <pre> <span class="log">requestHex:</span><br/>{{ v.message.requestHex }}</pre>
                                <pre> <span class="log">request.info:</span><br/>{{v.message.requestInfo.trim()}}</pre>
                                <pre> <span
                                        class="log">response:</span><br/>{{JSON.stringify(v.message.response, null, 2)}}</pre>
                                <pre> <span class="log">responseHex:</span><br/>{{ v.message.responseHex }}</pre>
                                <pre> <span
                                        class="log">response.info:</span><br/>{{v.message.responseInfo && v.message.responseInfo.trim()}}</pre>
                            </div>
                        </div>
                    </div>
                </el-row>
            </el-col>
        </el-row>
    </div>
</div>
</body>
<script src="/lib/vue/vue.js"></script>
<script src="/lib/element-ui/index.js"></script>
<script src="/lib/axios.min.js"></script>

<script>
    function groupBy(list, fn) {
        const groups = {}
        list.forEach(function (o) {
            const group = fn(o)
            groups[group] = groups[group] || []
            groups[group].push(o)
        })
        return groups
    }

    new Vue({
        methods: {
            generateUuid() {
                const s = [];
                const hexDigits = "0123456789abcdef";
                for (let i = 0; i < 36; i++) {
                    s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
                }
                s[14] = "4";   // bits 12-15 of the time_hi_and_version field to 0010
                s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);   // bits 6-7 of the clock_seq_hi_and_reserved to 01
                s[8] = s[13] = s[18] = s[23] = "-";
                const uuid = s.join("");
                return uuid;
            },
            processEvent(evt) {
                console.log("received:", evt)
                const message = JSON.parse(evt)
                if (message.code == 10002) {
                    this.info.push({
                        type: 'recv',
                        time: this.formatDate(new Date()),
                        message: message
                    })
                }
            },
            createWebSocket: function (socketId) {
                const that = this
                this.ws = new WebSocket(`ws://${location.host}/request/${socketId}`)
                this.ws.onopen = function () {
                    console.log('Opened ' + that.socketId)
                    that.ws.send(
                        JSON.stringify({
                            code: 10000,
                            message: 'start'
                        })
                    )
                }
                this.ws.onmessage = function (evt) {
                    that.processEvent(evt)
                }
                this.ws.onclose = function () {
                    console.log('Closed')
                }
                this.ws.onerror = function (err) {
                    console.log(err)
                }
            },
            toggleSelection(rows) {
                if (rows) {
                    rows.forEach(row => {
                        this.$refs.multipleTable.toggleRowSelection(row);
                    });
                } else {
                    this.$refs.multipleTable.clearSelection();
                }
            },
            chatScrollTop() {
                setTimeout(() => {
                    //滚动条长度
                    const currentDistance = this.$refs.chatScroll.scrollHeight - this.$refs.chatScroll.clientHeight;
                    //当前滚动条距离顶部的距离
                    let currentScroll_y = this.$refs.chatScroll.scrollTop;
                    if (currentDistance > 0 && currentDistance - currentScroll_y > 10) {
                        currentScroll_y = Math.ceil((currentDistance - currentScroll_y) / 10) + currentScroll_y;
                        currentScroll_y = currentScroll_y > currentDistance ? currentDistance : currentScroll_y;
                        this.$refs.chatScroll.scrollTop = currentScroll_y;
                        this.chatScrollTop()
                    }
                }, 13);
            },
            handleSelectionChange(val) {
                this.multipleSelection = val;
            },
            formatDate: function (date) {
                const seperator1 = "-";
                const seperator2 = ":";
                let month = date.getMonth() + 1;
                let strDate = date.getDate();
                if (month >= 1 && month <= 9) {
                    month = "0" + month;
                }
                if (strDate >= 0 && strDate <= 9) {
                    strDate = "0" + strDate;
                }
                return date.getFullYear() + seperator1 + month + seperator1 + strDate + " " + date.getHours() + seperator2 + date.getMinutes() + seperator2 + date.getSeconds();
            },
            validateRequest() {
                if (!this.request[0]) {
                    this.$message({
                        type: 'error',
                        message: "message can not be empty!"
                    })
                    return false
                }
                return true
            },
            submitForm() {
                const that = this;
                if (!this.validateRequest()) {
                    return
                }
                // that.loading = true
                that.chatScrollTop()
                if (this.post) {
                    that.postRequest()
                } else {
                    that.sendRequest()
                }
            },
            countDown(messageId) {
                const that = this
                setTimeout(() => {
                    if (that.requests[messageId].status === 'Pending') {
                        //TODO 冲正
                        that.requests[messageId].status = "TimedOut"
                        console.log(`${messageId} Timed out , reversing.`)
                        that.$message({
                            type: 'error',
                            message: `${messageId} Timed out , reversing.`
                        })
                    }
                }, 15 * 1000)
            },
            sendRequest() {
                const that = this
                const messageId = this.generateUuid()
                const message = {
                    code: 10001,
                    type: 'send',
                    status: "Pending",
                    time: this.formatDate(new Date()),
                    messageId: messageId,
                    message: that.request
                }
                const str = JSON.stringify(message)
                that.ws.send(str)
                that.requests[messageId] = message
                that.info.push(JSON.parse(str))
                that.countDown(messageId)
            },
            postRequest() {
                const that = this
                that.loading = true
                that.info.push({
                    type: 'send',
                    time: that.formatDate(new Date()),
                    message: JSON.parse(JSON.stringify(this.request))
                })
                axios.post("/message/json", this.request)
                    .then(function (response) {
                        that.loading = false
                        // response not implement yet
                        that.info.push({
                            type: 'recv',
                            time: that.formatDate(new Date()),
                            message: response.data
                        })
                        that.chatScrollTop()
                        that.response = response.data.request
                    })
                    .catch(function (error) {
                        that.loading = false
                        console.log(error)
                        that.$message({
                            type: 'error',
                            message: error.message
                        })
                    })
            },
            resetForm(formName) {
                this.$refs[formName].resetFields();
            }
            ,
            getData: function () {
                let that = this
                axios.get("/message/fields").then(response => {
                    that.fields = []
                    for (const k in response.data) {
                        that.fields.push(response.data[k])
                    }
                })
                axios.get("/message/templates").then(response => {
                    that.options = []
                    for (const k in response.data) {
                        const v = {}
                        for (const j in response.data[k]) {
                            v[j] = response.data[k][j].value
                        }
                        that.options.push(
                            {
                                label: k,
                                value: v
                            }
                        )
                    }
                })
            }
            ,
        },
        el: '#app',
        data() {
            const validateName = async (rule, value, callback) => {
                let that = this
                const res = await axios.get('/record/has?t=' + value);
                if (res.data.data !== 0) {
                    callback(new Error(''));
                } else {
                    callback();
                }
            };
            return {
                socketId: null,
                requests: {},
                hide: false,
                post: false,
                select: null,
                selectMessage: null,
                loading: false,
                response: {},
                request: {},
                fields: [],
                info: [],
                options: [],
                multipleSelection: [],
                rules: {
                    name: [
                        {required: true, message: '', trigger: 'blur'},
                        {validator: validateName, trigger: 'blur'}
                    ],
                    lane: [
                        {required: true, message: '', trigger: 'blur'}
                    ],
                }
            }
        },
        mounted() {
            this.getData()
            this.socketId = this.generateUuid();
            this.createWebSocket(this.socketId)
        }
    })
</script>

</html>